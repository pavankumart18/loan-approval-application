{% extends "base.html" %}

{% block title %}Loan Application - Step 3{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card fade-in">
            <div class="card-body p-5">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Step 3 of 3</span>
                        <span class="text-muted">100% Complete</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <h1 class="display-6 fw-bold text-primary">
                        <i class="fas fa-clock me-3"></i>Select Loan Tenure
                    </h1>
                    <p class="lead text-muted">Choose your repayment period for ₹{{ "%.0f"|format(amount) }} {{ loan_type.title() }} Loan</p>
                </div>

                <!-- STEP 3 FORM: Tenure selection (id=tenureForm) -->
                <form method="POST" id="tenureForm" class="mb-4">
                    <input type="hidden" name="step" value="3">
                    
                    <div class="row justify-content-center">
                        <div class="col-md-10">
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-4">
                                        <label for="tenure" class="form-label">
                                            <i class="fas fa-calendar-alt me-2"></i>Loan Tenure (Years)
                                        </label>
                                        <select class="form-control form-control-lg" id="tenure" name="tenure" required>
                                            <option value="">Select Tenure</option>
                                            {% for year in range(1, 31) %}
                                                <option value="{{ year }}" {% if tenure and tenure == year %}selected{% endif %}>{{ year }} {% if year == 1 %}year{% else %}years{% endif %}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">Choose a tenure that works best for your financial situation</div>
                                    </div>

                                    <!-- Quick Tenure Buttons -->
                                    <div class="mb-4">
                                        <label class="form-label">Popular Options:</label>
                                        <div class="row g-2">
                                            <div class="col-6 col-md-3">
                                                <button type="button" class="btn btn-outline-primary w-100" onclick="setTenure(this, 5)">5 Years</button>
                                            </div>
                                            <div class="col-6 col-md-3">
                                                <button type="button" class="btn btn-outline-primary w-100" onclick="setTenure(this, 10)">10 Years</button>
                                            </div>
                                            <div class="col-6 col-md-3">
                                                <button type="button" class="btn btn-outline-primary w-100" onclick="setTenure(this, 15)">15 Years</button>
                                            </div>
                                            <div class="col-6 col-md-3">
                                                <button type="button" class="btn btn-outline-primary w-100" onclick="setTenure(this, 20)">20 Years</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-calculator me-2"></i>Calculate EMI & Review
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Tenure Suggestions Section -->
                <div class="mt-5">
                    <h3 class="text-center mb-4">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>Recommended Tenure Options
                    </h3>
                    
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="suggestion-card card">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-clock fa-3x text-primary"></i>
                                    </div>
                                    <h5 class="card-title">Short Term</h5>
                                    <p class="text-muted">5 years</p>
                                    <div class="mb-3">
                                        <div class="fw-bold text-success">Lower Total Interest</div>
                                        <small class="text-muted">Pay less interest overall</small>
                                    </div>
                                    <div class="mb-3">
                                        <div class="fw-bold text-warning">Higher EMI</div>
                                        <small class="text-muted">₹{{ "%.0f"|format(amount * 0.025) }} approx</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm suggestion-btn" onclick="setTenure(this, 5)">
                                        <i class="fas fa-check me-1"></i>Select 5 Years
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="suggestion-card card border-primary">
                                <div class="card-body text-center position-relative">
                                    <div class="mb-3">
                                        <i class="fas fa-balance-scale fa-3x text-success"></i>
                                        <span class="badge bg-primary position-absolute top-0 start-50 translate-middle">RECOMMENDED</span>
                                    </div>
                                    <h5 class="card-title">Balanced</h5>
                                    <p class="text-muted">10 years</p>
                                    <div class="mb-3">
                                        <div class="fw-bold text-success">Optimal EMI</div>
                                        <small class="text-muted">Comfortable monthly payment</small>
                                    </div>
                                    <div class="mb-3">
                                        <div class="fw-bold text-info">Good Approval Rate</div>
                                        <small class="text-muted">85% approval chance</small>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm suggestion-btn" onclick="setTenure(this, 10)">
                                        <i class="fas fa-star me-1"></i>Select 10 Years
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="suggestion-card card">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-home fa-3x text-info"></i>
                                    </div>
                                    <h5 class="card-title">Long Term</h5>
                                    <p class="text-muted">20 years</p>
                                    <div class="mb-3">
                                        <div class="fw-bold text-info">Lower EMI</div>
                                        <small class="text-muted">₹{{ "%.0f"|format(amount * 0.012) }} approx</small>
                                    </div>
                                    <div class="mb-3">
                                        <div class="fw-bold text-warning">Higher Total Interest</div>
                                        <small class="text-muted">Pay more interest overall</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm suggestion-btn" onclick="setTenure(this, 20)">
                                        <i class="fas fa-check me-1"></i>Select 20 Years
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EMI Preview Section -->
                {% if emi %}
                <div class="mt-5">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>Loan Summary
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <div class="stats-card">
                                            <i class="fas fa-rupee-sign fa-2x mb-2"></i>
                                            <div class="stats-number">₹{{ "%.0f"|format(amount) }}</div>
                                            <div>Loan Amount</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <div class="stats-card">
                                            <i class="fas fa-percentage fa-2x mb-2"></i>
                                            <div class="stats-number">{{ interest_rate }}%</div>
                                            <div>Interest Rate</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <div class="row g-4">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h5 class="text-primary">Monthly EMI</h5>
                                        <div class="display-6 fw-bold text-success">₹{{ "%.0f"|format(emi) }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h5 class="text-primary">Total Interest</h5>
                                        <div class="display-6 fw-bold text-warning">₹{{ "%.0f"|format(total_interest) }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h5 class="text-primary">Total Amount</h5>
                                        <div class="display-6 fw-bold text-info">₹{{ "%.0f"|format(amount + total_interest) }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Final Submit Form -->
                            <form method="POST" class="mt-4" id="finalSubmitForm">
                                <input type="hidden" name="step" value="4">
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-check-circle me-2"></i>Submit Application
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="text-center mt-4">
                    <a href="{{ url_for('loan_application') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Amount
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set tenure on select and submit the tenure form (step 3)
    function setTenure(btn, tenure) {
        try {
            // set the select value
            const $select = $('#tenure');
            if ($select.length) {
                $select.val(tenure);
            }

            // Highlight the selected suggestion card
            $('.suggestion-card').removeClass('border-primary border-3');
            const card = btn.closest('.suggestion-card');
            if (card) {
                $(card).addClass('border-primary border-3');
            }

            // Submit only the tenureForm to calculate EMI (step 3)
            $('#tenureForm').submit();
        } catch (err) {
            console.error('setTenure error:', err);
            alert('An unexpected error occurred. Please refresh and try again.');
        }
    }

    $(document).ready(function() {
        // If server passed a 'tenure' value, leave it selected (template already does this).
        // Use sessionStorage for cross-page suggestion passing if you need it.
        const suggestedTenure = sessionStorage.getItem('suggestedTenure');
        if (suggestedTenure) {
            $('#tenure').val(suggestedTenure);
            sessionStorage.removeItem('suggestedTenure');
        }

        // Validate only the step-3 form before submit
        $('#tenureForm').on('submit', function(e) {
            const tenure = $('#tenure').val();
            if (!tenure) {
                alert('Please select a tenure period');
                e.preventDefault();
                return false;
            }
            // allow submit to proceed
        });

        // Final submit form validation (optional)
        $('#finalSubmitForm').on('submit', function(e) {
            // Ensure tenure still selected before final submit
            const tenure = $('#tenure').val();
            if (!tenure) {
                alert('Tenure missing. Please select tenure before submitting the application.');
                e.preventDefault();
                // optionally redirect to tenure form
                return false;
            }
            // allow final submit
        });
    });
</script>
{% endblock %}
